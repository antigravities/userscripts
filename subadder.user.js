// ==UserScript==
// @name         Sub Adder
// @namespace    https://alexandra.moe/
// @version      0.4
// @description  Add subs on SteamDB or the Steam store to your Barter.vg library with one click
// @author       Alexandra Frock <https://alexandra.moe/>
// @match        *://store.steampowered.com/sub/*
// @match        *://steamdb.info/sub/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

(function() {
    'use strict';

    if( GM_getValue('BarterID', 'none') == "none" ){
        var id = null;
        while( id === null ){
            id = prompt("Hello! Please enter your Barter ID below so that the Sub Adder userscript can work. It is found in your offers URL. For example, if my offers URL started with https://barter.vg/u/578/o/, my Barter ID would be 578.", "578");
        }
        GM_setValue('BarterID', id);
    }
    
    var id = GM_getValue('BarterID', 'none');
    
    var warning = "";

    var type = window.location.href.split("/")[2] == "store.steampowered.com" ? "steam" : "steamdb";
    
    if( type == "steamdb" && document.getElementById("apps") === null ) return;
    
    // Would like to avoid another cross-origin HTTP request if I can
    // Thanks to http://theemu.freecluster.eu/barter_sub_packages.html
  	var metaitems = {"333":{"name":"The Ship - Complete Pack","barterid":4645},"402":{"name":"Titan Quest Gold","barterid":4726},"433":{"name":"QUAKE III Arena + Team Arena","barterid":17911},"434":{"name":"QUAKE Collection","barterid":15504},"460":{"name":"Medieval II: Total War Collection","barterid":16037},"469":{"name":"The Orange Box","barterid":19193},"552":{"name":"Shadowgrounds Pack","barterid":17803},"603":{"name":"Max Payne Bundle","barterid":16466},"683":{"name":"Unreal Deal Pack","barterid":19262},"715":{"name":"Half-Life Complete","barterid":17734},"879":{"name":"Silverfall: Complete","barterid":11108},"927":{"name":"Pacific Storm Pack","barterid":17802},"964":{"name":"X-COM: Complete Pack","barterid":18926},"1007":{"name":"Children of the Nile Complete Pack","barterid":10992},"1529":{"name":"Company of Heroes Complete Pack","barterid":11098},"2102":{"name":"LucasArts Adventure Pack","barterid":14058},"2574":{"name":"Action Indie Pack","barterid":4530},"2821":{"name":"Death to Spies: Gold","barterid":4807},"2996":{"name":"Grand Ages: Rome GOLD","barterid":13009},"4156":{"name":"Commandos Collection","barterid":4611},"4172":{"name":"Sam and Max: Season 3 - The Devil's Playhouse (all episodes in 1)","barterid":16467},"4237":{"name":"AquaNox + AquaNox 2","barterid":13351},"4323":{"name":"Sid Meier's Civilization IV: The Complete Edition","barterid":4650},"4838":{"name":"SEGA Genesis Classics Pack 1","barterid":15560},"6015":{"name":"SEGA Genesis Classics Pack 2","barterid":15561},"6183":{"name":"Monkey Island: Special Edition Bundle","barterid":17816},"6253":{"name":"Tropico 3: Gold Edition","barterid":4625},"6375":{"name":"Gothic Universe Edition","barterid":18582},"6485":{"name":"SEGA Genesis Classics Pack 3","barterid":15562},"6673":{"name":"Guardians of Graxia + Map Pack","barterid":4529},"7096":{"name":"SEGA Genesis Classics Pack 4","barterid":15563},"7342":{"name":"NecroVisioN + NecroVisioN: Lost Company","barterid":8478},"7383":{"name":"Commander: Conquest of the Americas Complete Pack","barterid":13153},"7522":{"name":"Dreamcast Collection","barterid":4783},"7678":{"name":"Alien Breed Trilogy","barterid":4729},"7825":{"name":"SEGA Genesis Classics Collection","barterid":15565},"7967":{"name":"Sam and Max: Seasons 1-3 (aka Sam and Max Complete Pack)","barterid":16464},"8025":{"name":"Super Street Fighter IV: Arcade Edition","barterid":17829},"8224":{"name":"Syberia Bundle","barterid":9763},"8342":{"name":"Still Life Collection","barterid":9762},"8848":{"name":"Cthulhu Saves the World & Breath of Death VII Double Pack","barterid":13352},"11652":{"name":"HOARD Complete Pack","barterid":4655},"11691":{"name":"Humble Indie Frozenbyte Bundle","barterid":10909},"11707":{"name":"Sid Meier's Civilization V: GOTY","barterid":13008},"11712":{"name":"Gundemonium Collection","barterid":15568},"11732":{"name":"Supreme Commander Gold Edition","barterid":4593},"11762":{"name":"Sniper Ghost Warrior Gold Edition","barterid":4656},"11830":{"name":"Patrician IV Gold","barterid":4758},"11902":{"name":"Grand Theft Auto III Trilogy","barterid":16193},"12072":{"name":"L.A. Noire: The Complete Edition","barterid":16194},"12075":{"name":"Arcania + Gothic Pack","barterid":13156},"12169":{"name":"Tropico Trilogy","barterid":4430},"12171":{"name":"Geneforge Saga","barterid":15505},"12239":{"name":"Jamestown Deluxe Pack","barterid":4623},"12357":{"name":"F.E.A.R. Collection","barterid":15572},"12377":{"name":"Operation Flashpoint Complete","barterid":17756},"13237":{"name":"The Blackwell Bundle","barterid":4609},"13358":{"name":"Men of War: Assault Squad - Game of the Year Edition","barterid":8693},"13471":{"name":"Men of War: Assault Squad - DLC Pack","barterid":18179},"13535":{"name":"Alan Wake Collector's Edition","barterid":4539},"13656":{"name":"Two Worlds II: Velvet Edition","barterid":4756},"13680":{"name":"iBomber Bundle","barterid":4622},"13743":{"name":"Orcs Must Die Game of the Year","barterid":4648},"13770":{"name":"Worms Reloaded: Game of the Year Edition","barterid":9839},"13794":{"name":"Take on Helicopters Bundle","barterid":13290},"14181":{"name":"Disciples III: Gold Edition","barterid":4429},"14221":{"name":"Kingdoms of Amalur: Reckoning - Collection","barterid":4629},"14297":{"name":"Blades of Time - Limited Edition","barterid":11106},"14299":{"name":"Men of War: Collector Pack","barterid":10279},"14311":{"name":"A Valley Without Wind 1 and 2 Dual Pack","barterid":4725},"14445":{"name":"SEGA Genesis Classics Pack 5","barterid":15564},"14522":{"name":"Iron Grip Warlord with Scorched Earth DLC","barterid":14250},"14583":{"name":"Avernum Bundle - The Great Trials Trilogy","barterid":15570},"14622":{"name":"The Dream Machine Bundle","barterid":12938},"14857":{"name":"Krater - Collector's Edition","barterid":4817},"15190":{"name":"Dead Island: Game of the Year Edition","barterid":4755},"15198":{"name":"Tom Clancy's Ghost Recon Future Soldier - Deluxe","barterid":16540},"15351":{"name":"Warhammer 40,000: Space Marine Collection","barterid":18885},"15361":{"name":"Duke Nukem Forever Collection","barterid":17735},"15407":{"name":"Alan Wake Franchise","barterid":16973},"15408":{"name":"The Binding of Isaac Collection","barterid":16465},"15481":{"name":"Dungeon Defenders Collection","barterid":4736},"15544":{"name":"Ridge Racer Unbounded Bundle","barterid":14200},"15630":{"name":"Red Faction Collection","barterid":18583},"15892":{"name":"The Book of Unwritten Tales Digital Deluxe Edition","barterid":4594},"15933":{"name":"Dungeons of Dredmor Complete","barterid":4735},"16523":{"name":"Humble Indie Bundle 6 Bonus","barterid":10908},"17085":{"name":"Sanctum: Collection","barterid":4649},"17092":{"name":"Empire: Total War Collection","barterid":16038},"17093":{"name":"Napoleon: Total War Collection","barterid":9597},"17761":{"name":"Frontline Tactics Complete Pack","barterid":4657},"17798":{"name":"Divinity Anthology","barterid":18176},"17881":{"name":"Orcs Must Die 2 - Complete Pack","barterid":4647},"17933":{"name":"Saints Row: The Third - The Full Package","barterid":5836},"18139":{"name":"Ticket to Ride Complete Pack","barterid":10089},"18259":{"name":"Orcs Must Die! Franchise Pack","barterid":19761},"18260":{"name":"Mass Effect Collection","barterid":4612},"18261":{"name":"Max Payne 3 Complete","barterid":16195},"18408":{"name":"Total War: Shogun 2 Collection","barterid":16166},"18445":{"name":"The Book of Unwritten Tales: The Critter Chronicles Collectors Edition","barterid":19934},"18644":{"name":"Assassin's Creed 3 Deluxe Edition","barterid":16539},"18777":{"name":"Darksiders Franchise Pack","barterid":8607},"19080":{"name":"Defense Grid: Containment Bundle","barterid":12903},"19282":{"name":"Tropico 4 Collector's Bundle","barterid":4646},"26391":{"name":"Lunar Pack","barterid":16917},"26683":{"name":"Anno 2070 Complete Edition","barterid":9413},"27013":{"name":"The Walking Dead: Survival Instinct - Walker Herd Survival Pack","barterid":4634},"27824":{"name":"Binary Domain Collection","barterid":16378},"27831":{"name":"Worms Ultimate Mayhem - Deluxe Edition","barterid":4733},"28005":{"name":"The Night of the Rabbit Premium Edition","barterid":12906},"28187":{"name":"The Elder Scrolls V: Skyrim - Legendary Edition","barterid":10369},"28354":{"name":"Penny Arcade's On the Rain-Slick Precipice of Darkness 3 and 4 Bundle","barterid":10368},"29180":{"name":"Risen 2: Dark Waters Gold Edition","barterid":15402},"29197":{"name":"Valve Complete Pack","barterid":18252},"30265":{"name":"Tom Clancy's Splinter Cell Blacklist Deluxe Edition","barterid":15477},"30560":{"name":"Warhammer 40,000: Dawn of War - Master Collection","barterid":4781},"30561":{"name":"Warhammer 40,000: Dawn of War II - Grand Master Collection","barterid":20585},"30564":{"name":"Chivalry: Complete Pack","barterid":4785},"31161":{"name":"PAC-MAN Championship Edition DX+ All You Can Eat Edition Bundle","barterid":14057},"31292":{"name":"Dishonored - Definitive Edition (aka Dishonored - Game of the Year Edition)","barterid":10964},"31398":{"name":"Wizardry 6 and 7","barterid":4627},"31437":{"name":"Worms Revolution Gold Edition","barterid":17815},"31591":{"name":"Just Cause 2: DLC Collection","barterid":15474},"31601":{"name":"Tomb Raider DLC Collection","barterid":12907},"31772":{"name":"Winter Voices Complete Pack","barterid":18860},"32031":{"name":"Penumbra Collectors Pack","barterid":16067},"32847":{"name":"7th Guest & 11th Hour Bundle","barterid":4728},"32848":{"name":"Borderlands 2 Game of the Year","barterid":4631},"33739":{"name":"Grimm Complete Pack","barterid":15571},"33764":{"name":"Sword of the Stars: The Pit - Gold Edition","barterid":4635},"33921":{"name":"99 Spirits - Steam Special Edition","barterid":13971},"34096":{"name":"PixelJunk Monsters Ultimate + Shooter Bundle","barterid":18037},"34410":{"name":"Celebrat10n TrackMania Complete Pack","barterid":17511},"34431":{"name":"GRID 2 All In DLC Pack","barterid":17757},"34432":{"name":"Grid 2 Reloaded Edition","barterid":18419},"34522":{"name":"The Incredible Adventures of Van Helsing - Complete Pack","barterid":4732},"34681":{"name":"Secret Files Franchise Pack","barterid":11107},"35015":{"name":"Desperados Collection","barterid":4610},"35268":{"name":"Cities in Motion 2 Collection","barterid":18659},"35269":{"name":"Cities in Motion 1 and 2 Collection","barterid":15503},"35378":{"name":"Dark Fall Collection","barterid":17223},"35969":{"name":"Sanctum 2 Complete Pack","barterid":15428},"35978":{"name":"Etherlords Bundle","barterid":4727},"36025":{"name":"Awesomenauts Power Pack","barterid":4784},"36075":{"name":"Sid Meier's Civilization V: Complete Edition","barterid":13013},"36487":{"name":"Men of War: Assault Squad 2 - Deluxe Edition","barterid":4632},"36855":{"name":"SpellForce Complete","barterid":16852},"36904":{"name":"Sniper: Ghost Warrior Trilogy","barterid":15573},"37223":{"name":"Hearts of Iron Collection III (Jan 2014)","barterid":17486},"38166":{"name":"Sid Meier's Ace Patrol Bundle","barterid":18775},"39131":{"name":"Sniper Elite: Nazi Zombie Army Bundle","barterid":4613},"39160":{"name":"The Tale of ALLTYNEX","barterid":9016},"39962":{"name":"Scourge: Outbreak Ambrosia Bundle","barterid":17595},"40595":{"name":"Dracula Trilogy","barterid":4592},"41066":{"name":"The Inner World Bundle","barterid":14088},"42344":{"name":"Professional Farmer 2014 Platinum Edition","barterid":17559},"43429":{"name":"Haegemonia Bundle","barterid":5807},"44033":{"name":"Hitman Absolution: Elite Edition","barterid":9955},"44162":{"name":"Daedalic Adventure Bundle","barterid":18681},"44166":{"name":"The Dark Eye Universe Bundle","barterid":17222},"44169":{"name":"Metro Redux Bundle","barterid":15430},"44369":{"name":"Warhammer 40,000: Dawn of War II - Retribution - Complete DLC Collection","barterid":16152},"44455":{"name":"Adventure Bundle Vol. 1","barterid":4614},"44834":{"name":"ibb & obb - Best Friends Forever Double Pack","barterid":8888},"45469":{"name":"How to Survive - Storm Warning Edition","barterid":9903},"45516":{"name":"Space Hulk - Ultimate Pack","barterid":13155},"45615":{"name":"Fallout Classic Collection","barterid":18464},"45714":{"name":"FATE: Hero Bundle","barterid":10752},"45894":{"name":"Tex Murphy Complete Pack","barterid":18678},"46028":{"name":"Far Cry Franchise Pack","barterid":4753},"46504":{"name":"Saints Row Ultimate Franchise Pack (\"Gat Out of Hell\" not included)","barterid":16663},"46657":{"name":"The Incredible Adventures of Van Helsing Franchise Pack","barterid":4628},"46740":{"name":"Anomaly Ãœber Bundle","barterid":16974},"47304":{"name":"1C Space Collection","barterid":16009},"48191":{"name":"Doorways: Chapters 1 to 3 Collection","barterid":16689},"48344":{"name":"Zombie Driver HD Complete Edition","barterid":16519},"48535":{"name":"The Typing of The Dead: Overkill Collection","barterid":4633},"48978":{"name":"Surgeon Simulator: Anniversary Edition","barterid":18967},"49306":{"name":"AI War Bundle (2014)","barterid":4630},"49740":{"name":"Just Cause Collection","barterid":9956},"49783":{"name":"Tomb Raider GOTY Edition","barterid":18354},"49903":{"name":"Hitman Collection","barterid":17104},"49909":{"name":"Kane and Lynch Collection","barterid":8935},"50291":{"name":"Secret of the Magic Crystals Complete","barterid":15555},"50353":{"name":"The Book of Unwritten Tales 2 Almanac Edition","barterid":17834},"50628":{"name":"Planetary Annihilation - Digital Deluxe Commander Bundle","barterid":18721},"50718":{"name":"The Guild Collection","barterid":17636},"50790":{"name":"Age of Empires Legacy Bundle Including The Forgotten","barterid":13154},"51328":{"name":"Defense Grid 2 Special Edition","barterid":12904},"51669":{"name":"PlayWay's Sim Bundle","barterid":15566},"51714":{"name":"Outland - Special Edition (includes Artbook and OST)","barterid":14038},"53560":{"name":"Pool Nation & Bumper Pack Bundle","barterid":15476},"53813":{"name":"Costume Quest 1 & 2 Bundle","barterid":17064},"54408":{"name":"PAYDAY 2: GOTY Edition","barterid":15502},"54410":{"name":"PAYDAY 2: Heist Bundle","barterid":15473},"54469":{"name":"Real World Racing Bundle","barterid":15574},"54623":{"name":"Cherry Tree High Complete Pack","barterid":9015},"54978":{"name":"Small World 2 Complete pack","barterid":10090},"55062":{"name":"The Daedalic Armageddon Bundle","barterid":10775},"55835":{"name":"Braveland Collection","barterid":15475},"56520":{"name":"Evolve Digital Deluxe","barterid":17835},"56692":{"name":"Life Is Strange Complete Season (Episodes 1-5)","barterid":18470},"58139":{"name":"Supreme League of Patriots Season Pass","barterid":18508},"58602":{"name":"Life is Strange Season Pass (Episodes 2-5)","barterid":18718},"59404":{"name":"MacVenture Series Collection","barterid":9014},"59637":{"name":"Spiderweb Software Complete Pack","barterid":15569},"61462":{"name":"Sword of Asumi - Deluxe Edition","barterid":14037},"61948":{"name":"3D Realms Anthology - Steam Edition","barterid":18038},"62585":{"name":"Jetdogs Adventure Pack - Volume 1","barterid":17227},"62896":{"name":"BioShock Triple Pack","barterid":17224},"63228":{"name":"Out There: Î© Edition + Soundtrack","barterid":17987},"63481":{"name":"Borderlands: The Pre-Sequel + Season Pass","barterid":19048},"63734":{"name":"Cultures: Northland + 8th Wonder of the World","barterid":19188},"63830":{"name":"Cuban Missile Crisis + Ice Crusade Pack","barterid":17107},"65812":{"name":"The Evil Within Bundle","barterid":18463},"66682":{"name":"Quell Collection","barterid":18471},"66904":{"name":"Developer Alliance Bundle","barterid":15567},"66986":{"name":"Star Wars Collection","barterid":13172},"67167":{"name":"Risen 3 - Complete Edition","barterid":15401},"67169":{"name":"Sacred 3 Gold","barterid":19458},"67373":{"name":"Risen Franchise Pack","barterid":15403},"67777":{"name":"Duke Nukem Kill-A-Ton Collection","barterid":16112},"71448":{"name":"Mahjong Pretty Girls Battle Bundle Pack","barterid":16524},"71780":{"name":"Max Gentlemen - Triple DLC Pack","barterid":18265},"71910":{"name":"Pinball Thrills Triple Pack","barterid":18717},"72017":{"name":"Why So Evil Duology Pack","barterid":13021},"72343":{"name":"Blues and Bullets - Complete Season (Episodes 1-5)","barterid":18477},"73035":{"name":"Axis Game Factory's + Zombie FPS + Zombie Survival Pack DLC","barterid":18886},"73792":{"name":"Inner Demons Pack - Face It + Soul Gambler","barterid":15892},"74582":{"name":"Art Appreciation Pack","barterid":16520},"75074":{"name":"Space Hulk Ascension Edition Ultimate Pack","barterid":18945},"75194":{"name":"Hyperspace Pack","barterid":17226},"75825":{"name":"The Incredible Adventures of Van Helsing Anthology","barterid":17221},"76949":{"name":"Labyronia Bundle","barterid":17105},"77607":{"name":"Vapour + Soundtrack","barterid":17779},"78303":{"name":"Braveland Trilogy","barterid":16076},"78661":{"name":"Ghostship Bundle","barterid":17804},"79549":{"name":"Alien: Isolation Collection","barterid":18439},"79867":{"name":"Sniper Elite 3 + Season Pass","barterid":17833},"80281":{"name":"Teddy Floppy Ear Bundle","barterid":18178},"80341":{"name":"Saints Row Ultimate Franchise Pack (\"Gat out of Hell\" included)","barterid":16662},"80886":{"name":"Last Days of Spring Visual Novel + Soundtrack","barterid":17753},"81729":{"name":"Surgeon Simulator AE + I Am Bread","barterid":18420},"81845":{"name":"Divinity: Original Sin Enhanced Edition - Collector's Edition","barterid":16893},"82862":{"name":"JRPG Bundle","barterid":17081},"84670":{"name":"Ticket to Ride DLCs Complete Pack","barterid":17808},"84759":{"name":"Company of Heroes 2: Master Collection","barterid":20583},"86905":{"name":"The GooBundle","barterid":18177},"88338":{"name":"EQ Games Puzzle Pack","barterid":19187},"89144":{"name":"Focus Selection Pack (December 2015)","barterid":19005},"91065":{"name":"Zonitron Productions Ten Games Pack","barterid":20674}};
  
    GM_xmlhttpRequest({
        method: "GET",
        url: window.location.href.split("/")[0] + "//store.steampowered.com/dynamicstore/userdata",
        onload: function(resp){
            
          	var sub = parseInt(window.location.href.split("?")[0].split("/")[4]);
          
            var userdata = JSON.parse(resp.responseText);
            if( userdata.rgOwnedPackages.indexOf(sub) == -1 ) warning="you do not own this package";
            
            var items = [];
            
            if( type == "steam" ){
                Array.prototype.slice.call(document.getElementsByClassName("tab_item_overlay")).forEach(function(v){
                    items.push(v.href.split("/")[4]);
                });
            } else if( type == "steamdb" ){
                Array.prototype.slice.call(document.getElementById("apps").children[1].children[1].children).forEach(function(v,k){
                    items.push(v.getAttribute("data-appid"));
                });
            }
            
            items.forEach(function(v){
               if( userdata.rgOwnedApps.indexOf(parseInt(v)) == -1 ) warning="you do not own all of the apps in this package";
            });
          
            var fm = "{{button}}<input type='hidden' name='change_attempted' value=1></input><input type='hidden' name='action' value='Edit'></input>";
            
          	if( metaitems.hasOwnProperty(""+sub) ){
              items = metaitems[""+sub].barterid;
              if( warning.length > 0 ) warning=", " + warning;
              warning="this will add the Barter meta-item \"" + metaitems[""+sub].name + "\" (" + metaitems[""+sub].barterid + ") to your library" + warning;
              fm+="<input type='hidden' name='add_game_id' value='" + items + "'></input>";
            } else {
              items = items.join(",");
              fm+="<input type='hidden' name='bulk_AppIDs' value='" + items + "'></input><input type='hidden' name='add_from' value='AppIDs'></input>";
            }

            var formTemplate = "<form action='https://barter.vg/u/" + id + "/l/e/#modified' method='POST' id='barterPOSTform'>" + fm + "</form>";
            
            if( type == "steam" ){
                var button = "<input type='submit' class='btnv6_blue_hoverfade btn_medium' value='Add this sub to your Barter.vg library'";
                if( warning.length > 0 ) button+=" data-store-tooltip='<b style=\"color: red;\">Warning(s): " + warning + "</span>'";
                button += "></input>";
                document.getElementsByClassName("block responsive_apppage_details_right")[0].innerHTML+=formTemplate.replace("{{button}}", button);
                BindStoreTooltip($J(".btn_medium"));
            } else if( type == "steamdb" ){
                var button = "<a href='#' onClick='document.getElementById(\"barterPOSTform\").submit();'";
                if( warning.length > 0 ) button+=" class='tooltipped' aria-label='Warning(s): " + warning + "'";
                document.getElementsByClassName("pagehead-actions")[0].innerHTML+=button + ">Add this sub to your Barter.vg library</a>" + formTemplate.replace("{{button}}", "");
            }
        }
    });

})();
